<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<HTML lang="pl">
<HEAD>
<META HTTP-EQUIV="Content-Type"       CONTENT="text/html; charset=ISO-8859-2">
<META HTTP-EQUIV="Content-Language"   CONTENT="pl">
<META http-equiv="Content-Style-Type" content="text/css">
<META HTTP-EQUIV="X-Frame-Options"    CONTENT="DENY">
<LINK rel="stylesheet" href="../asm.css" type="text/css">

<TITLE> Asembler: Linuks, czê¶æ 12 - Linia poleceñ i ¶rodowisko </TITLE>
<link rel="Start"    hreflang="pl" lang="en" href="../index.htm" >
<link rel="Prev"     hreflang="pl" lang="en" href="linux11.html" >
<link rel="Next"     hreflang="pl" lang="en" href="linux13.html" >
<link rel="Contents" hreflang="pl" lang="en" href="../index.htm" >

<META NAME="Author" CONTENT="Bogdan D.">
<META NAME="Description" CONTENT="Kurs jêzyka asembler">
<META NAME="Keywords" CONTENT="kurs, asm, asembler, assembler, linia poleceñ, PSP, ¶rodowisko,
	command line, environment, linux, linuks">
<META NAME="Language" CONTENT="pl">
<META NAME="Generator" CONTENT="KWrite">
<meta http-equiv="Last-Modified" content="Tue, Jan 18 2011 17:59:58 CEST">
</HEAD><BODY>

<div class="c">Jak pisaæ programy w jêzyku asembler pod Linuksem?<BR>
	<h1 class="nag">Czê¶æ 12 - Czego od nas pragn±, czyli linia poleceñ programu.
	 Zmienne ¶rodowiska</h1></div>

<P>
Teraz zajmiemy siê do¶æ istotn± spraw± z punktu widzenia programisty i u¿ytkownika
oprogramowania: lini± poleceñ. Nie wszyscy lubi± podawaæ dane programowi w czasie jego
pracy i odpowiadaæ na pytania o dane. Czêsto (o ile jest to mo¿liwe) mo¿na
tego oszczêdziæ i zamiast bezustannie zadawaæ u¿ytkownikowi pytania, przeczytaæ, co wpisano
nam w liniê poleceñ. Umo¿liwia to pisanie programów, które raz uruchomione z prawid³ow± lini±
poleceñ nie pytaj± ju¿ siê o nic a tylko wykonuj± swoj± pracê bez przeszkadzania
u¿ytkownikom.
</P>
<P>
Przejd¼my wiêc do szczegó³ów. Je¶li kto¶ z Was zna jêzyk C, to na pewno wie, jak zadeklarowaæ
funkcjê g³ówn± programu tak, aby mog³a odczytaæ parametry i zmienne ¶rodowiska. Deklaracja
taka wygl±da zazwyczaj tak:</P>
<PRE>		int main (int argc, char *argv[], char *env[])</PRE>
<P>gdzie:</P>
<UL>
 <LI> <CODE>argc</CODE> - liczba ca³kowita mówi±ca o tym, z jak± ilo¶ci± parametrów uruchomiono
	nasz program.
	</LI>
 <LI> <CODE><span lang="en">char</span> *argv[]</CODE> -
 	 tablica wska¼ników do poszczególnych parametrów. Tutaj,
	<CODE>argv[0]</CODE> - nazwa uruchomionego programu, <CODE>argv[1]</CODE> - pierwszy
	parametr programu itd.
	</LI>
 <LI> <CODE><span lang="en">char</span> *env[]</CODE> - tablica wska¼ników do zmiennych ¶rodowiskowych.
	</LI>
</UL>
<P>Ale gdzie s± te zmienne?<BR>
Na stosie, oczywi¶cie!<BR>
Po wykonaniu typowego prologu do funkcji (czyli <code><span lang="en">push</span> ebp / mov ebp, esp</code>),
 zmienna <q>argc</q> znajduje
siê w [ebp+4], wska¼niki do parametrów linii poleceñ zaczynaj± siê od [ebp+8]
i id± w górê stosu, po nich jest
wska¼nik zerowy i dalej w górê s± wska¼niki do zmiennych ¶rodowiska,
 te¿ zakoñczone wska¼nikiem zerowym.
</P>
<P>
Wszystko ³adnie wygl±da w teorii, ale jak tego u¿ywaæ?<BR>
Aby odpowiedzieæ na to pytanie, napisa³em ten oto krótki programik. Jedynym celem jego ¿ycia
jest wy¶wietlenie, z iloma argumentami go wywo³ano (co najmniej jeden - nazwa programu),
wy¶wietlenie tych argumentów i zmiennych ¶rodowiska.<BR>
<BR>
A teraz kod:</P>
	<BR><a href="#linux1201" tabindex="1" class="bezdruk">(przeskocz program wy¶wietlaj±cy liniê poleceñ)</a>
<PRE>
; Program wy¶wietla w³asn± liniê poleceñ i zmienne ¶rodowiskowe.
;
; Autor: Bogdan D.
; kontakt: bogdandr (at) op (dot) pl
;
; nasm -O999 -f elf liniap.asm
; ld -s -o liniap liniap.o bibl/lib/libasmio.a
;
; fasm liniap.asm liniap.o
; ld -s -o liniap liniap.o bibl/lib/libasmio.a

	; przyda siê nam moja biblioteczka
%include &quot;bibl/incl/linuxbsd/nasm/std_bibl.inc&quot;
section .text
global _start

; FASM:
; format ELF
; include &quot;bibl/incl/linuxbsd/fasm/std_bibl.inc&quot;
; section &quot;.text&quot; executable
; public _start


_start:
	push	ebp		; typowy prolog, o którym wspomnia³em
	mov	ebp, esp

%idefine	argc	ebp+4		; liczba parametrów
%idefine	argv	ebp+8		; parametry

; FASM:
; 	argc	equ	ebp+4		; liczba parametrów
;	argv	equ	ebp+8		; parametry


	mov	eax, [argc]		; EAX = liczba parametrów
	pisz32e				; wypisz EAX
	nwln				; przejd¼ do nowej linii

	xor	edi, edi		; zerujemy licznik
					; wy¶wietlonych parametrów

wypisz_argv:
	cmp	edi, eax		; czy liczba wy¶wietlonych =
					; = liczba parametrów?
	je	koniec_wypisz_argv	; je¶li tak, to koniec
					; wy¶wietlania parametrów

	mov	esi, [argv+edi*4]	; pobierz parametr numer EDI.
					; ka¿dy wska¼nik jest czterobajtowy,
					; dlatego mno¿ymy EDI przez 4.

	pisz_esi			; wypisz napis pod adresem ESI
					; czyli nasz parametr
	nwln				; przejd¼ do nowej linii

	add	edi, 1			; wybieramy kolejny parametr
	jmp	short	wypisz_argv	; i idziemy pisaæ od nowa

koniec_wypisz_argv:
			; parametry siê skoñczy³y. Teraz bêdzie jeden
			; wska¼nik zerowy i zmienne ¶rodowiska

	inc	edi			; przeskocz wska¼nik zerowy

wypisz_env:
        mov     esi, [argv+edi*4]	; pobierz zmienn± ¶rodowiskow±

	test	esi, esi		; sprawd¼, czy nie wska¼nik zerowy
	jz	koniec_wypisz_env	; je¶li zero, to skoñczyli¶my

        pisz_esi			; wypisz zmienn± ¶rodowiskow±
        nwln				; przejd¼ do nowej linii

        add     edi, 1			; przechodzimy na kolejna zmienn±
        jmp     short   wypisz_env	; i wypisujemy dalej


koniec_wypisz_env:
	wyjscie				; koniec...</PRE>

<P><a name="linux1201" id="linux1201">Jak widaæ, nie by³o to a¿ takie trudne</a>
 jak siê mog³o zdawaæ na pocz±tku. W³a¶nie poznali¶cie
kolejn± rzecz, która jest ³atwa w u¿yciu, a mo¿liwo¶ci której s± du¿e. Teraz bêdziecie mogli
¶mia³o zacz±æ pisaæ programy, których jedynym kana³em komunikacyjnym z u¿ytkownikiem
bêdzie linia poleceñ, co znacznie upro¶ci ich obs³ugê.<BR>
</P>
<P>
Tylko pamiêtajcie o dodaniu kodu wy¶wietlaj±cego sposób u¿ycia programu, gdy nie podano mu
¿adnych parametrów.</P>

<br><br>
<div class="bezdruk">
<a accesskey="3" hreflang="pl" href="linux11.html">Poprzednia czê¶æ kursu</a> (Alt+3)<br>
<a accesskey="4" hreflang="pl" href="linux13.html">Kolejna czê¶æ kursu</a> (Alt+4)<br>
<A accesskey="1" hreflang="pl" href="../index.htm">Spis tre¶ci off-<span lang="en">line</span></a> (Alt+1)<BR>
<A accesskey="2" hreflang="pl" href="../index.php">Spis tre¶ci on-<span lang="en">line</span></a> (Alt+2)<br>
<A accesskey="0" hreflang="pl" href="../ulatwie.htm">U³atwienia dla niepe³nosprawnych</a> (Alt+0)<BR>
</div>


<BR><BR><HR>
<h2 class="nag">Æwiczenia</h2>
<OL>
 <LI>Napisz program, który utworzy plik podany jako parametr. Je¶li podano drugi parametr
	(oddzielony od pierwszego spacj±), zapisz jego warto¶æ do tego pliku. Je¶li nie podano
	¿adnych parametrów, niech program wypisze stosown± wiadomo¶æ.<BR><BR></LI>

 <LI>Napisz program, który oblicza <acronym title="Najwiêkszy Wspólny Dzielnik">NWD</acronym>
 	 (patrz czê¶æ 8) dwóch liczb podanych na linii poleceñ.
	Je¶li nie podano wystarczaj±cej liczby parametrów, niech program wy¶wietli stosown±
	wiadomo¶æ.</LI>
</OL>


</BODY></HTML>
