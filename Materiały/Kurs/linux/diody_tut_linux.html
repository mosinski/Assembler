<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<HTML lang="pl">
<HEAD>
<META HTTP-EQUIV="Content-Type"       CONTENT="text/html; charset=ISO-8859-2">
<META HTTP-EQUIV="Content-Language"   CONTENT="pl">
<META http-equiv="Content-Style-Type" content="text/css">
<META HTTP-EQUIV="X-Frame-Options"    CONTENT="DENY">
<LINK rel="stylesheet" href="../asm.css" type="text/css">

<TITLE> Asembler: Linuks: Manipulacja diodami klawiatury </TITLE>
<link rel="Start"    hreflang="pl" lang="en" href="../index.htm" >
<link rel="Contents" hreflang="pl" lang="en" href="../index.htm" >

<link rel="alternate" type="text/html" href="diody_tut_linux_en.html"
	hreflang="en" lang="en" title="English version">

<META NAME="Author" CONTENT="Bogdan D.">
<META NAME="Description" CONTENT="Manipulacja diodami klawiatury pod Linuksem">
<META NAME="Keywords" CONTENT="klawiatura, diody, LED, asm, assembler, asembler">
<META NAME="Language" CONTENT="pl">
<META NAME="Generator" CONTENT="Kwrite">
<meta http-equiv="Last-Modified" content="Tue, Jan 18 2011 17:59:57 CEST">
</HEAD><BODY>

<h1 class="nag">Zabawa diodami na klawiaturze pod Linuksem</h1>


<P>Aby uczyniæ swój program bardziej atrakcyjnym wzrokowo i pochwaliæ siê swoimi umiejêtno¶ciami,
mo¿na sprawiæ, aby diody na klawiaturze wskazuj±ce stan
<span lang="en">Num Lock, Caps Lock, Scroll Lock</span> zaczê³y migotaæ w jakim¶ rytmie.<BR>
Teraz poka¿ê, jak to zrobiæ.</P>

<P>Do manipulowania urz±dzeniem znakowym (klawiatur±) pos³u¿ymy siê funkcj± systemow±
<span class="b">sys_ioctl</span> (numer 54).
 Najpierw jednak trzeba siê dowiedzieæ, jakich komend mo¿emy u¿ywaæ.
W tym celu udajemy siê do pliku <span class="b">/usr/include/linux/kd.h</span> lub do manuala, je¶li mamy
w nim stronê ioctl_list, a w nim mamy (po angielsku):</P>
	<BR><a href="#diody_tut_linux01" tabindex="1" class="bezdruk">(przeskocz komendy)</a>
<PRE>
	#define KDGETLED 0x4B31  /*zwróæ bie¿±cy stan diód */
	#define KDSETLED 0x4B32  /*ustaw stan diód (¶wiate³ek, nie flag)*/
	#define LED_SCR  0x01    /*dioda scroll lock */
	#define LED_NUM  0x02    /*dioda num lock */
	#define LED_CAP  0x04    /*dioda caps lock */</PRE>

<P><a name="diody_tut_linux01" id="diody_tut_linux01">Jedn± z tych dwóch pierwszych warto¶ci</a>
wpiszemy do ECX.<BR>
 Tymczasem w EBX musimy mieæ deskryptor otwartego
pliku <span class="b">/dev/console</span> (do zapisu) lub warto¶æ 1, która oznacza standardowe urz±dzenie
wyj¶cia - STDOUT.<BR>
W EDX podajemy ostatni parametr: warto¶æ 0-7 je¶li ustawiamy stan diód lub wska¼nik (adres)
na zmienn± typu DWORD, która otrzyma bie¿±ca warto¶æ stanu diód (tak¿e 0-7).
</P>
<P>
Widaæ wiêc, co musi zrobiæ nasz program: zachowaæ bie¿±cy stan diód, dowolnie je pozmieniaæ
(i zadbaæ by efekt by³ widoczny - robiæ pauzy), po czym przywróciæ poprzedni stan.<BR>
Oto, jak taki program móg³by wygl±daæ (u¿ywanie za³±czników z mojej biblioteki nie jest
konieczne - w kodzie mówiê, jak i co zamieniæ).</P>
	<BR><a href="#diody_tut_linux02" class="bezdruk">(przeskocz przyk³adowy program)</a>
<PRE>
; Program manipuluje diodami klawiatury
;
; Autor: Bogdan D.
; Kontakt: bogdandr (at) op (dot) pl
;
; nasm -f elf klaw.asm
; ld -s -o klaw klaw.o


section .text

		; nie musicie z tego korzystaæ:
%include &quot;bibl/incl/linuxbsd/nasm/n_system.inc&quot;
%include &quot;bibl/incl/linuxbsd/nasm/n_const.inc&quot;

%define	KDGETLED	0x4b31
%define	KDSETLED	0x4b32

global _start

_start:

; 1. otwieramy /dev/console, w trybie tylko do zapisu lub
; korzystamy ze STDOUT

	mov	eax, sys_open	; sys_open = 5 (otwieramy plik)
	mov	ebx, konsola	; adres nazwy pliku
	mov	ecx, O_WRONLY	; O_WRONLY = 01
	mov	edx, 777q	; RWX dla wszystkich
	int	80h

	cmp	eax, 0
	jge	.ok		; jak nie ma b³êdu, to jedziemy dalej

				; w przypadku b³êdu korzystamy ze STDOUT
	mov	eax, stdout	; stdout = 1

; 2. pobieramy aktualny stan diód

.ok:
	mov	ebx, eax	; EBX = deskryptor pliku

	mov	eax, sys_ioctl	; sys_ioctl = 54 - manipulacja urz±dzeniem
	mov	ecx, KDGETLED	; pobierz stan diód
	mov	edx, stare_diody	; adres DWORDa, który otrzyma
					; aktualny stan diód
	int	80h

	mov	eax, sys_ioctl	; sys_ioctl = 54
	mov	ecx, KDSETLED	; ustawiamy stan diód
	mov	edx, 7		; wszystkie w³±czone
	int	80h

        mov	cx, 7
        mov	dx, 0a120h	; opó¼nienie pó³ sekundy
	call	pauza

; przywracamy poprzedni stan diód

	mov	eax, sys_ioctl
	mov	ecx, KDSETLED		; ustawiamy stan diód
	mov	edx, [stare_diody]	; EDX = poprzedni stan diód
	int	80h

	cmp	ebx, stdout	; czy otworzyli¶my konsolê, czy STDOUT?
	jle	.koniec		; nie zamykamy STDOUT

	mov	eax, sys_close	; zamykamy otwarty plik konsoli
	int	80h

.koniec:
	wyjscie			; czyli
				;	mov	eax, 1
				;	xor	ebx, ebx
				;	int	80h


pauza:			; procedura pauzuj±ca przez CX:DX milisekund
	push    ebx
	push    ecx
	push    edx

	mov     ax, cx
	shl     eax, 16
	mov     ebx, 1000000
	mov     ax, dx 		; EAX = CX:DX
	xor     edx, edx
	div     ebx		; CX:DX dzielimy przez milion
	mov     [t1 + timespec.tv_sec], eax 	; EAX = liczba sekund

	mov     ebx, 1000
	mov     eax, edx	; EAX = pozosta³a liczba mikrosekund
	mul     ebx
	mov     [t1 + timespec.tv_nsec], eax 	; EAX = liczba nanosekund

	mov     eax, sys_nanosleep	; funkcja numer 162
	mov     ebx, t1
	mov     ecx, t2
	int     80h

	pop     edx
	pop     ecx
	pop     ebx

	ret

section .data

stare_diody	dd	0
konsola		db	&quot;/dev/console&quot;,0

; Struktura timespec jest zdefiniowana w pliku n_system.inc
;struc timespec
;	        .tv_sec:		resd 1
;	        .tv_nsec:		resd 1
;endstruc

t1 istruc timespec
t2 istruc timespec</PRE>

<P>
<a name="diody_tut_linux02" id="diody_tut_linux02">Dalsze eksperymenty pozostawiam</a> czytelnikom.
 Pamiêtajcie, ¿e istnieje a¿ 8 ró¿nych kombinacji
stanów diód i mo¿na przecie¿ robiæ ró¿ne odstêpy czasowe miêdzy zmian± stanu.
</P>

<P>Mi³ej zabawy.</P>

<br>
<div class="bezdruk">
<A accesskey="1" hreflang="pl" href="../index.htm">Spis tre¶ci off-<span lang="en">line</span></a> (Alt+1)<BR>
<A accesskey="2" hreflang="pl" href="../index.php">Spis tre¶ci on-<span lang="en">line</span></a> (Alt+2)<br>
<A accesskey="0" hreflang="pl" href="../ulatwie.htm">U³atwienia dla niepe³nosprawnych</a> (Alt+0)<BR>
</div>

</BODY></HTML>
