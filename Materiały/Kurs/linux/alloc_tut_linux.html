<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<HTML lang="pl">
<HEAD>
<META HTTP-EQUIV="Content-Type"       CONTENT="text/html; charset=ISO-8859-2">
<META HTTP-EQUIV="Content-Language"   CONTENT="pl">
<META http-equiv="Content-Style-Type" content="text/css">
<META HTTP-EQUIV="X-Frame-Options"    CONTENT="DENY">
<LINK rel="stylesheet" href="../asm.css" type="text/css">

<TITLE> Asembler: Linuks: Dynamiczna alokacja pamiêci </TITLE>
<link rel="Start"    hreflang="pl" lang="en" href="../index.htm" >
<link rel="Contents" hreflang="pl" lang="en" href="../index.htm" >

<link rel="alternate" type="text/html" href="alloc_tut_linux_en.html"
	hreflang="en" lang="en" title="English version">

<META NAME="Author" CONTENT="Bogdan D.">
<META NAME="Description" CONTENT="Dynamiczna alokacja pamiêci pod Linuksem">
<META NAME="Keywords" CONTENT="asm, assembler, asembler, Linux, Linuks, alokacja pamiêci,
	malloc, sys_brk, brk()">
<META NAME="Language" CONTENT="pl">
<META NAME="Generator" CONTENT="KWrite">
<meta http-equiv="Last-Modified" content="Tue, Jan 18 2011 17:59:56 CEST">
</HEAD><BODY>

<h1 class="nag">Dynamiczna alokacja pamiêci pod Linuksem</h1>

<P>
Ju¿ w ¶rednio zaawansowanych programach pojawia siê potrzeba dynamicznego rezerwowania pamiêci,
w czasie dzia³ania programu, nie wiedz±c z góry, ile pamiêci bêdzie potrzeba. Na
 przyk³ad, u¿ytkownik podaje nam rozmiar tablicy a my musimy tak± tablicê utworzyæ i na niej operowaæ
 (nie znaj±c wcze¶niej nawet maksymalnego jej rozmiaru). Rozwi±zaniem takich problemów jest
 w³a¶nie dynamiczna alokacja pamiêci. Pod Linuksem pamiêæ alokuje siê funkcj± <span class="b">sys_brk</span>
 (ustalaj±c± najwy¿szy dostêpny adres w sekcji danych). Przyjmuje ona jeden argument:</P>
 <UL>
  <LI>EBX = 0, je¶li chcemy otrzymaæ aktualny najwy¿szy dostêpny dla nas adres w sekcji danych.
      Tê warto¶æ powiêkszymy potem o ¿±dany rozmiar pamiêci.</LI>
  <LI>EBX ró¿ny od 0, je¶li chcemy ustawiæ nowy najwy¿szy adres w sekcji danych. Adres musi byæ
  	 rozs±dny co do warto¶ci i taki, by rezerwowana pamiêæ nie wchodzi³a na biblioteki
  	 za³adowane dynamicznie podczas samego uruchamiania programu.</LI>
 </UL>
<P>Je¶li co¶ siê nie uda³o, sys_brk zwróci -1 (i ustawi odpowiednio zmienn± errno) lub te¿ zwróci
ujemny kod b³êdu.</P>
<P>
Oczywi¶cie, argument funkcji mo¿e byæ wiêkszy (alokacja) lub mniejszy (zwalnianie pamiêci) od
 warto¶ci zwróconej przez sys_brk przy EBX=0.
</P>
<P>
Jak widaæ, teoria nie jest skomplikowana. Przejd¼my wiêc mo¿e do przyk³adu. Ten krótki programik
 ma za zadanie zaalokowaæ 16<abbr title="kilobajt">kB</abbr> pamiêci
 (specjalnie tak du¿o, ¿eby przekroczyæ 4kB - rozmiar jednej strony pamiêci
 - i udowodniæ, ¿e pamiêæ rzeczywi¶cie zosta³a przydzielona) i wyzerowaæ j± (normalnie zapisywanie
 po nieprzydzielonej pamiêci skoñczy siê zamkniêciem programu przez system).
</P>
	<BR><a href="#alloc_tut_linux01" tabindex="1" class="bezdruk">(przeskocz program)</a>
<PRE title="program ilustruj±cy dynamiczn± alokacjê pamiêci">
; Dynamiczna alokacja pamiêci pod Linuksem
;
; Autor: Bogdan D., bogdandr (at) op.pl
;
; kompilacja:
;
; nasm -f elf -o alok_linux.o alok_linux.asm
; ld  -o alok_linux alok_linux.o


section	.text
global	_start

_start:

	mov	eax, 45		; sys_brk
	xor	ebx, ebx
	int	80h

	add	eax, 16384	; tyle chcemy zarezerwowaæ
	mov	ebx, eax
	mov	eax, 45		; sys_brk
	int	80h

	cmp	eax, 0
	jl	.problem	; je¶li b³±d, to wychodzimy i nic siê
				; nie wy¶wietli

	mov	edi, eax	; EDI = najwy¿szy dostêpny adres

	sub	edi, 4		; EDI wskazuje na ostatni dostêpny DWORD
	mov	ecx, 4096	; tyle DWORDów zaalokowali¶my
	xor	eax, eax	; bêdziemy zapisywaæ zera
	std			; idziemy wspak
	rep	stosd		; zapisujemy ca³y zarezerwowany obszar
	cld			; przywracamy flagê DF do normalnego stanu

	mov	eax, 4
	mov	ebx, 1
	mov	ecx, info
	mov	edx, info_dl
	int	80h		; wy¶wietlenie napisu

.problem:

	mov	eax, 1
	xor	ebx, ebx
	int	80h



section	.data

info		db	&quot;Udana alokacja pamieci.&quot;, 10
info_dl		equ	$ - info</PRE>

<br><br>
<div class="bezdruk">
<A accesskey="1" hreflang="pl" href="../index.htm" name="alloc_tut_linux01" id="alloc_tut_linux01">Spis tre¶ci off-<span lang="en">line</span></a> (Alt+1)<BR>
<A accesskey="2" hreflang="pl" href="../index.php">Spis tre¶ci on-<span lang="en">line</span></a> (Alt+2)<br>
<A accesskey="0" hreflang="pl" href="../ulatwie.htm">U³atwienia dla niepe³nosprawnych</a> (Alt+0)<BR>
</div>

</BODY></HTML>
